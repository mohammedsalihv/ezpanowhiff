<header class="header-area header-style-1">
    <div id="main-header-higlights" style="background-color:#ffffff; border:1px solid #ffffff; color:black"
        class="header-top header-top-ptb-1 d-none d-lg-block">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-xl-3 col-lg-4">
                    <div style="color: #ffffff;" class="header-info">
                        <ul>
                            <li id="header-li-bg-clr">
                                <a style="color: black; font-weight:900;" href="/userHome">Home</a>
                            </li>
                            <li id="header-li-bg-clr"><a style="color: black; font-weight:900;"
                                    href="/userProductlist">Shop </a>
                            </li>
                            <li id="header-li-bg-clr">
                                <a style="color: black; font-weight:900;" href="/userAccount">Account</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-xl-6 col-lg-4">
                    <div class="text-center">
                        <div style="color: black;" id="news-flash" class="d-inline-block">
                            <ul>

                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-4">
                    <div class="header-info header-info-right">
                        <ul>

                            <div class="header-action-right">
                                <div class="header-action-2">
                                    <div class="header-action-icon-2">
                                        <a href="/wishlistPage">
                                            <img class="svgInject" alt="Evara"
                                                src="assets/imgs/theme/icons/icon-heart.svg">
                                            <span style="background-color: #ffffff; color:rgb(255, 255, 255)"
                                                class="pro-count "></span>
                                        </a>
                                    </div>
                                    <div class="header-action-icon-2">
                                        <a class="mini-cart-icon" href="/cart">
                                            <img alt="Evara" src="assets/imgs/theme/icons/icon-cart.svg">
                                            <span style="background-color: #ffffff; color:rgb(255, 255, 255)"
                                                class="pro-count #"></span>
                                        </a>

                                    </div>
                                </div>
                            </div>
                            {{#if this.userLogged}}
                            <div class="d-flex justify-content-right ml-4 mt-2">
                                <button style="background: transparent; border:none" onclick="logoutConfirmation()" type="button">
                                    <i style="color: #000000; font-size:x-large; " class="fa-solid fa-user"></i><i
                                        style="color: #000000; font-size:small"
                                        class="fa-solid fa-right-from-bracket"></i>
                                </button>
                            </div>
                            {{else}}
                            <li>
                                <div style="margin-left: 42%;" class="d-flex justify-content-right "></div>
                                <i class="fi-rs-user"></i><a style="color: #046963;" href="/login">Log In / Sign Up</a>
                    </div>
                    </li>
                    {{/if}}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    </div>
</header>
<main class="main">
    <div class="page-header breadcrumb-wrap" style="background-color: #ffffff;">
        <div class="container d-flex justify-content-center">
            <div class="breadcrumb">
                <a href="/userHome" rel="nofollow">Home</a>
                <span></span> <a href="/userProductlist">Shop</a>
                <span></span> <a href="/cart">Your Cart</a>
            </div>
        </div>
    </div>
    <section>
        <div class="text-center">
            <h5>{{this.messageNoproducts}}</h5>
            <h5>{{this.messageNoqty}}</h5>
        </div>
        {{#if noQty}}
        <div style="text-align: center; font-weight:900" class="alert alert-success">
            {{noQty}}
        </div>
        {{/if}}
    </section>
    <input type="hidden" id="user-id" value="{{this.userId}}" /> <!-- Assuming user is available -->
    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table shopping-summery text-center clean">
                            <thead class="header-in-cart">
                                <tr>
                                   
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Subtotal</th>
                                    <th>Remove</th>
                                </tr>
                            </thead>
                            <tbody class="body-in-cart">
                                {{#each cart.products}}
                                <tr data-id="{{product._id}}" data-stock="{{product.Qty}}">
                                    <td id="body-in-cart" class="image product-thumbnail">
                                        <img style="height: 70px; width:70px;" src="/images/cropped_{{product.img1}}"
                                            alt="#">
                                        <br>
                                        {{#if product.Qty}}
                                        {{else}}
                                        <span style="color: red; font-weight:700">The product currently out of
                                            stock</span>
                                        {{/if}}
                                    </td>
                                    <td id="body-in-cart" class="product-des product-name">
                                        <h5 class="product-name">
                                            <a href="/productDetail?id={{this._id}}">{{product.productName}}</a>
                                        </h5>
                                    </td>
                                    <td style="font-size: medium;" id="body-in-cart" class="price" data-title="Price">
                                        <span>{{product.price}}</span>
                                    </td>
                                    <td id="body-in-cart" data-title="Stock">
                                        <button style="background-color: #000000; color:#ffffff;"
                                            class="cart-item-count mr-3">-</button>
                                        <span class="quantity">{{this.cartCount}}</span>
                                        <button style="background-color: #000000; color:#ffffff;"
                                            class="cart-item-count ml-3">+</button>
                                    </td>
                                    <td style="font-size: medium;" id="body-in-cart" data-title="subTotal">
                                        <div id="subTotal">
                                            <span class="subtotal" id="product-subtotal-{{product._id}}">{{multiply
                                                this.cartCount product.price}}</span>
                                        </div>
                                    </td>
                                    <td id="body-in-cart" data-title="Remove">
                                        <a onclick="removeProduct('{{product._id}}')" class="bf">
                                            <i class="fi-rs-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>

                        </table>
                    </div>
                    <section>
                        <div class="cart-action text-end mb-4">
                            <a href="/userHome" id="continue-cart-btn" style="background-color: #000000;"><i
                                    class="fi-rs-shopping-bag mr-10"></i>Continue Shopping</a>
                        </div>
                    </section>
                    <div class="row mb-50">
                        <div class="col-lg-6 col-md-12">
                            <div class="mb-30 mt-50">
                                <div class="total-amount">
                                    <div class="left">
                                        <div class="coupon">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12">
                            <div class="border p-md-4 p-30 border-radius cart-totals">
                                <div class="heading_s1 mb-3">
                                    <h4>Cart Totals</h4>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <tbody>
                                            <tr>
                                                <td class="cart_total_label">Cart total</td>
                                                <td class="cart_total_amount">
                                                    <span class="font-lg fw-900 text-brand">
                                                        <div id="cart-total">{{cart.cartTotal}}</div>
                                                    </span>
                                                </td>
                                            </tr>
                                           
                                            <tr>
                                                <td class="cart_total_label">Total</td>
                                                <td class="cart_total_amount">
                                                    <strong>
                                                        <span class="font-xl fw-900 text-brand">
                                                            <div id="cart-main-total">{{cart.cartTotal}}.00</div>
                                                        </span>
                                                    </strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <button onclick="proceedTocheckout()" id="btn-checkout">
                                    <a href="#" id="tag-checkout"> <i class="fi-rs-box-alt mr-10"></i> Proceed To
                                        CheckOut</a>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


<script>

    function proceedTocheckout(){
        window.location.href = ' /checkoutPage'
    }
   
</script>
<script>
 document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.cart-item-count').forEach(button => {
        button.addEventListener('click', () => {
            const row = button.closest('tr');
            const productId = row.getAttribute('data-id');
            const availableStock = parseInt(row.getAttribute('data-stock'));
            const count = button.classList.contains('mr-3') ? -1 : 1;
            const userId = document.getElementById('user-id').value; // Assuming userId is available in the DOM

            const quantitySpan = row.querySelector('.quantity');
            const currentQuantity = parseInt(quantitySpan.textContent);

            if (currentQuantity + count > availableStock) {
                Swal.fire("Cannot exceed available stock");
                return;
            }

            if (currentQuantity + count < 1) {
                 Swal.fire("Quantity cannot be less than 1");
                return;
            }

            fetch('/update-cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, prod: productId, count }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.cart) {
                    const updatedProduct = data.cart.products.find(item => item.product._id === productId);
                    quantitySpan.textContent = updatedProduct.cartCount;
                    row.querySelector('.subtotal').textContent = (updatedProduct.cartCount * updatedProduct.product.price).toFixed(2);
                    document.getElementById('cart-total').textContent = data.cart.cartTotal.toFixed(2);
                    document.getElementById('cart-main-total').textContent = data.cart.cartTotal.toFixed(2);
                } else {
                    console.error('Error updating cart:', data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
});

</script>

<script>
function updateSelected(productId) {
    // AJAX to send a request to the server to update the cart data
    console.log('Box selected');
    fetch(`/updateSelected/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to update product selection');
    })
    .then(data => {
        console.log('data fetch ', data);
        window.location.reload()
        // Update UI based on the response
        updateCartTotal(data.cartTotal);
         
    })
    .catch(error => {
        console.error(error);
    });
}

function updateCartTotal(cartTotal) {
    // Update the cart total in the UI without refreshing the page
    document.getElementById('cart-Total').innerText = cartTotal;
    document.getElementsByClassName('cart-main-Total').innerText = cartTotal;
}

</script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <script>
        async function removeProduct(productId) {
           
          
            try {
                const confirmation = await Swal.fire({
                    icon: 'warning',
                    title: 'Are you sure?',
                    text: `Do you really want to remove the product  ?`,
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove it!',
                    cancelButtonText: 'Cancel',
                });
    
                if (confirmation.isConfirmed) {
                    const response = await fetch(`/item-delete/${productId}`, {
                        method: 'DELETE',
                    });
    
                    if (response.ok) {
                        await Swal.fire({
                            icon: 'success',
                            title: 'Product Removed',
                            text: `Product  removed successfully.`,
                        });
    
                        // You can update the UI or take additional actions here
                        window.location.reload();
                    } else {
                        await Swal.fire({
                            icon: 'error',
                            title: 'Failed to Remove Product',
                            text: `Failed to remove product with ID .`,
                        });
                    }
                } else {
                    // User clicked Cancel
                    await Swal.fire({
                        icon: 'info',
                        title: ' Canceled',
                        text: 'Product removal canceled by the user.',
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while processing the request.',
                });
            }
        }
    </script>

<script>
    async function clearCart(){
        try {
            const confirmation = await Swal.fire({
                icon: 'warning',
                title: 'Are you sure?',
                text: `Do you really want to clear your cart?`,
                showCancelButton: true,
                confirmButtonText: 'Yes, remove it!',
                cancelButtonText: 'Cancel',
            });

            if (confirmation.isConfirmed) {
                // Redirect to the route for clearing the cart
                window.location.href = `/cart-Clear`;
            } else {
                // User clicked Cancel
                await Swal.fire({
                    icon: 'info',
                    title: 'Cancelled',
                    text: 'Cart clearing cancelled.',
                });
            }
        } catch (error) {
            console.error('Error:', error);
            await Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing the request.',
            });
        }
    }
</script>
<script src="/Javascript/logout.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
function logoutConfirmation() {
    Swal.fire({
        title: 'Are you sure?',
        text: "You will be logged out!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, log out!'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire(
                'Logged out!',
                'You have been logged out.',
                'success'
            ).then(() => {
                window.location.href = "/userLogout";
            });
        } else {
            window.location.href = "/userHome";
        }
    });
}
</script>